// --- LÓGICA DEL ESCÁNER CORREGIDA ---
let isProcessing = false; // Flag para evitar duplicados

function startScanner() {
    isProcessing = false; // Reset cada vez que abrimos
    
    Quagga.init({
        inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#scanner-container') },
        decoder: { readers: ["ean_reader", "ean_8_reader", "code_128_reader"] },
        locate: true // Mejora la detección centrada
    }, function(err) {
        if (err) { alert("Error cámara: " + err); return; }
        Quagga.start();
    });

    Quagga.onDetected(function(result) {
        if (isProcessing) return; // Si ya detectó uno, ignora el resto
        
        isProcessing = true; // Bloqueamos nuevas detecciones
        const code = result.codeResult.code;
        
        // Detenemos Quagga inmediatamente para que no siga leyendo
        Quagga.stop();
        
        if (navigator.vibrate) navigator.vibrate(100); // Feedback táctil
        
        // Llamamos a la API y cerramos la interfaz de cámara
        fetchBarcodeData(code);
        toggleScanner(); 
    });
}
