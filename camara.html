<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Diabetes AI - Expert Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <style>
        .size-btn.active { background-color: #3b82f6; border-color: #60a5fa; color: white; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen p-4">

    <div class="max-w-md mx-auto space-y-4">
        <div class="bg-slate-900 border border-slate-800 p-4 rounded-3xl flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black text-blue-500 italic">EXPERTO <span class="text-white">SIN B츼SCULA</span></h1>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Ratio Reforzado: 6.0</p>
            </div>
            <div class="text-right">
                <span id="label-size" class="text-[10px] bg-blue-900/50 text-blue-300 px-2 py-1 rounded-lg border border-blue-500/30">RACI칍N MEDIA</span>
            </div>
        </div>

        <div class="relative rounded-[2.5rem] overflow-hidden border-2 border-slate-800 aspect-square">
            <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
            <div class="absolute inset-0 border-[30px] border-black/10 pointer-events-none"></div>
            <button onclick="procesarPlato()" class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-blue-600 px-10 py-4 rounded-2xl font-black shadow-2xl active:scale-95 transition-all">
                游닞 ANALIZAR PLATO
            </button>
        </div>

        <div class="grid grid-cols-3 gap-2">
            <button onclick="setSize(0.7, 'PEQUE칌A')" class="size-btn bg-slate-800 p-3 rounded-xl text-[10px] font-bold border border-slate-700">POCAS<br>PATATAS</button>
            <button onclick="setSize(1.0, 'MEDIA')" class="size-btn active bg-slate-800 p-3 rounded-xl text-[10px] font-bold border border-slate-700">RACI칍N<br>NORMAL</button>
            <button onclick="setSize(1.4, 'GRANDE')" class="size-btn bg-slate-800 p-3 rounded-xl text-[10px] font-bold border border-slate-700">PLATO<br>LLENO</button>
        </div>

        <div class="bg-slate-900 p-6 rounded-[2rem] border border-slate-800 shadow-xl">
            <div id="lista-alimentos" class="space-y-3 mb-4">
                <p class="text-slate-600 text-sm text-center italic">Escanea para identificar componentes...</p>
            </div>
            <div class="flex justify-between items-end pt-4 border-t border-slate-800">
                <div>
                    <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Total Estimado</span>
                    <div id="total-hc" class="text-4xl font-black text-white">0g</div>
                </div>
                <div class="text-right">
                    <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Raciones</span>
                    <div id="total-rac" class="text-xl font-bold text-blue-400">0.0</div>
                </div>
            </div>
        </div>

        <div class="bg-blue-600 p-6 rounded-[2.5rem] shadow-xl space-y-4">
            <input type="number" id="glucemia" placeholder="Glucemia actual" class="w-full bg-blue-700 border-none p-4 rounded-2xl text-2xl font-bold text-white placeholder-blue-300 outline-none">
            <button onclick="calcularDosisFinal()" class="w-full bg-white text-blue-600 py-5 rounded-2xl font-black text-xl shadow-inner uppercase tracking-tighter">Calcular Bolo</button>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-slate-950/98 flex items-center justify-center z-50 p-6">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-sm rounded-[3rem] p-10 text-center shadow-2xl">
            <p class="text-slate-500 text-[10px] font-black uppercase mb-4">Dosis Recomendada (Paso 0.5)</p>
            <div class="py-10 bg-slate-800/50 rounded-[2.5rem] border border-slate-700 mb-8">
                <span id="ui-final" class="text-9xl font-black text-white">0.0</span>
                <span class="block text-blue-500 font-bold text-2xl mt-2 italic">Unidades</span>
            </div>
            <button onclick="document.getElementById('modal').classList.add('hidden')" class="w-full bg-blue-600 py-4 rounded-2xl font-black">ENTENDIDO</button>
        </div>
    </div>

    <script>
        const RATIO_AGRESIVO = 6.0; 
        const FSI = 33.3; 
        const OBJETIVO = 120;
        
        let net;
        let factorTama침o = 1.0;
        let gramosTotales = 0;

        // BASE DE DATOS PROFESIONAL - CATEGORIZADA
        const EXPERT_DB = {
            "fries": { esp: "Patatas Fritas", hc: 40, icon: "游" },
            "potato": { esp: "Patata Cocida/Asada", hc: 20, icon: "游볪" },
            "rice": { esp: "Arroz Blanco / Paella", hc: 45, icon: "游꼨" },
            "pizza": { esp: "Pizza", hc: 50, icon: "游꼣" },
            "hamburger": { esp: "Hamburguesa (con pan)", hc: 40, icon: "游꼢" },
            "bread": { esp: "Pan / Rebanada", hc: 25, icon: "游" },
            "pasta": { esp: "Pasta / Spaguetti", hc: 50, icon: "游꼫" },
            "steak": { esp: "Prote칤na (Carne/Lomo)", hc: 2, icon: "游볼" }, // 2g por salsas
            "chicken": { esp: "Pollo", hc: 0, icon: "游꼥" },
            "apple": { esp: "Fruta", hc: 15, icon: "游꼝" },
            "dough": { esp: "Boller칤a / Masa", hc: 45, icon: "游볧" }
        };

        async function init() {
            net = await mobilenet.load();
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            document.getElementById('video').srcObject = stream;
        }

        function setSize(val, txt) {
            factorTama침o = val;
            document.getElementById('label-size').innerText = "RACI칍N " + txt;
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if (gramosTotales > 0) procesarPlato(); // Recalcula si ya hay datos
        }

        async function procesarPlato() {
            const predictions = await net.classify(document.getElementById('video'));
            const lista = document.getElementById('lista-alimentos');
            lista.innerHTML = "";
            gramosTotales = 0;
            let encontrados = new Set();

            predictions.forEach(p => {
                const tag = p.className.toLowerCase();
                for (let key in EXPERT_DB) {
                    if (tag.includes(key) && !encontrados.has(key)) {
                        const item = EXPERT_DB[key];
                        const hcAjustado = Math.round(item.hc * factorTama침o);
                        gramosTotales += hcAjustado;
                        encontrados.add(key);

                        lista.innerHTML += `
                            <div class="flex justify-between items-center bg-slate-800/50 p-3 rounded-2xl border border-slate-700">
                                <div class="flex items-center gap-3">
                                    <span class="text-xl">${item.icon}</span>
                                    <span class="text-[10px] font-bold uppercase">${item.esp}</span>
                                </div>
                                <span class="font-black text-blue-400">${hcAjustado}g</span>
                            </div>`;
                    }
                }
            });

            // Si es un Lomo Saltado (Carne + Patatas) y la IA se l칤a:
            if (gramosTotales === 0) {
                gramosTotales = Math.round(45 * factorTama침o);
                lista.innerHTML = `<p class="text-center text-[10px] text-blue-400 font-bold uppercase tracking-widest">Combinado Prote칤na + Almid칩n (${gramosTotales}g)</p>`;
            }

            document.getElementById('total-hc').innerText = gramosTotales + "g";
            document.getElementById('total-rac').innerText = (gramosTotales / 10).toFixed(1) + " R";
        }

        function calcularDosisFinal() {
            const glu = parseFloat(document.getElementById('glucemia').value);
            if (!glu) return alert("Pon tu glucemia actual");

            let uComida = gramosTotales / RATIO_AGRESIVO;
            let uCorr = glu > OBJETIVO ? (glu - OBJETIVO) / FSI : 0;
            
            // REDONDEO CRUCIAL A PASOS DE 0.5 PARA TU PLUMA
            let total = Math.round((uComida + uCorr) * 2) / 2;

            document.getElementById('ui-final').innerText = total.toFixed(1);
            document.getElementById('modal').classList.remove('hidden');
        }

        init();
    </script>
</body>
</html>
