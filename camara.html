<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Diabetes AI Professional Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
</head>
<body class="bg-slate-950 text-white font-sans p-4">

    <div class="max-w-md mx-auto space-y-4">
        <div class="flex justify-between items-center border-b border-slate-800 pb-4">
            <h1 class="text-xl font-black text-blue-500 tracking-tighter">DIABETES <span class="text-white">CORE AI</span></h1>
            <span class="bg-blue-900/50 text-blue-400 text-[10px] px-2 py-1 rounded border border-blue-500">v4.0 PRO</span>
        </div>

        <div class="relative rounded-[2rem] overflow-hidden border-2 border-slate-800 aspect-square shadow-2xl">
            <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
            <div id="scanner-line" class="absolute top-0 left-0 w-full h-1 bg-blue-500/50 shadow-[0_0_15px_blue] animate-bounce"></div>
            <button onclick="analizarPlatoPro()" class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-blue-600 px-8 py-4 rounded-2xl font-black shadow-xl active:scale-95 transition-all">
                游댌 ANALIZAR COMPONENTES
            </button>
        </div>

        <div class="bg-slate-900 p-5 rounded-3xl border border-slate-800">
            <h2 class="text-[10px] font-bold text-slate-500 uppercase mb-4 tracking-widest text-center">Desglose Nutricional</h2>
            <div id="resultado-analisis" class="space-y-3">
                <p class="text-slate-600 text-sm italic text-center">Esperando captura de imagen...</p>
            </div>
            <div class="mt-6 pt-4 border-t border-slate-800 flex justify-between items-center">
                <span class="text-slate-400 font-bold">Total Hidratos:</span>
                <span id="total-hc" class="text-3xl font-black text-blue-400">0g</span>
            </div>
        </div>

        <div class="bg-blue-600 p-6 rounded-[2.5rem] shadow-xl">
            <input type="number" id="glucemia" placeholder="Glucemia actual" class="w-full bg-blue-700 border-none rounded-2xl p-4 text-2xl font-bold text-white placeholder-blue-300 outline-none mb-4">
            <button onclick="calcularBolo()" class="w-full bg-white text-blue-600 py-4 rounded-2xl font-black text-lg">CALCULAR DOSIS EXACTA</button>
        </div>
    </div>

    <div id="modal-dosis" class="hidden fixed inset-0 bg-slate-950/98 z-50 flex items-center justify-center p-6">
        <div class="bg-slate-900 border border-slate-700 w-full rounded-[3rem] p-10 text-center shadow-2xl">
            <p class="text-slate-500 text-[10px] font-black uppercase mb-4">Dosis de Insulina (Pluma 0.5)</p>
            <div class="text-9xl font-black text-white mb-2" id="ui-final">0.0</div>
            <p class="text-blue-500 font-bold text-xl mb-10">UNIDADES</p>
            <button onclick="document.getElementById('modal-dosis').classList.add('hidden')" class="w-full bg-slate-800 py-4 rounded-2xl font-bold">CERRAR</button>
        </div>
    </div>

    <script>
        const RATIO = 6.0; // Ratio corregido para subir +3 unidades
        const FSI = 33.3;  // Factor sensibilidad para DTI 54
        const OBJ = 120;
        let net;

        // BASE DE DATOS PROFESIONAL (Basada en raciones est치ndar de nutrici칩n)
        const NUTRITION_DB = {
            "potatoes": { esp: "Patatas (Fritas/Asadas)", hc: 40 },
            "french fries": { esp: "Patatas Fritas", hc: 45 },
            "rice": { esp: "Arroz Blanco/Paella", hc: 50 },
            "bread": { esp: "Pan / Bocadillo", hc: 30 },
            "hamburger": { esp: "Hamburguesa (Con Pan)", hc: 45 },
            "pizza": { esp: "Pizza Italiana", hc: 55 },
            "pasta": { esp: "Pasta / Spaguetti", hc: 60 },
            "steak": { esp: "Carne / Prote칤na", hc: 0 },
            "chicken": { esp: "Pollo", hc: 0 },
            "hotdog": { esp: "Perrito Caliente", hc: 30 },
            "apple": { esp: "Manzana", hc: 15 },
            "banana": { esp: "Pl치tano", hc: 22 }
        };

        async function init() {
            net = await mobilenet.load();
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            document.getElementById('video').srcObject = stream;
        }

        async function analizarPlatoPro() {
            const video = document.getElementById('video');
            const result = await net.classify(video);
            
            const display = document.getElementById('resultado-analisis');
            display.innerHTML = "";
            let totalHC = 0;

            // Filtramos las predicciones con m치s del 15% de probabilidad
            result.forEach(pred => {
                const tags = pred.className.toLowerCase().split(', ');
                tags.forEach(tag => {
                    for (let key in NUTRITION_DB) {
                        if (tag.includes(key)) {
                            const data = NUTRITION_DB[key];
                            totalHC += data.hc;
                            
                            display.innerHTML += `
                                <div class="flex justify-between items-center bg-slate-800/50 p-3 rounded-2xl border border-slate-700">
                                    <span class="text-xs font-bold text-blue-400 uppercase tracking-tighter">${data.esp}</span>
                                    <span class="font-black">${data.hc}g</span>
                                </div>`;
                            return; // Evita duplicar el mismo objeto
                        }
                    }
                });
            });

            if (totalHC === 0) {
                // Fallback de seguridad si no reconoce pero hay algo
                totalHC = 45; 
                display.innerHTML = "<p class='text-center text-[10px] text-slate-500 uppercase'>Plato Mixto Detectado (Estimaci칩n Est치ndar)</p>";
            }

            document.getElementById('total-hc').innerText = totalHC + "g";
            window.lastHC = totalHC;
        }

        function calcularBolo() {
            const glu = parseFloat(document.getElementById('glucemia').value);
            if (!glu) return alert("Introduce glucemia");

            let uComida = window.lastHC / RATIO;
            let uCorr = glu > OBJ ? (glu - OBJ) / FSI : 0;
            
            // Redondeo profesional a pasos de 0.5
            let total = Math.round((uComida + uCorr) * 2) / 2;

            document.getElementById('ui-final').innerText = total.toFixed(1);
            document.getElementById('modal-dosis').classList.remove('hidden');
        }

        init();
    </script>
</body>
</html>
