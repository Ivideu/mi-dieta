<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Diabetes AI Pro - Auto Segment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f8fafc; }
        #canvas-container { position: relative; width: 100%; aspect-ratio: 1; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; h-full; border-radius: 2rem; }
        .loading-overlay { background: rgba(0,0,0,0.8); backdrop-blur: 5px; }
    </style>
</head>
<body class="p-4 pb-20">

    <div class="max-w-md mx-auto space-y-4">
        <header class="flex justify-between items-center bg-slate-900/50 p-4 rounded-3xl border border-slate-800">
            <div>
                <h1 class="text-xl font-black text-blue-500 italic">AUTO<span class="text-white">SCAN</span></h1>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Ratio: 7.5 | DTI: 54</p>
            </div>
            <div id="ai-status" class="text-[9px] bg-amber-500/20 text-amber-500 px-2 py-1 rounded border border-amber-500/30 font-bold">CARGANDO IA...</div>
        </header>

        <div id="canvas-container" class="bg-black rounded-[2.5rem] overflow-hidden border-2 border-slate-800 shadow-2xl">
            <video id="video" autoplay playsinline class="w-full h-full object-cover opacity-50"></video>
            <canvas id="canvas"></canvas>
            
            <button id="main-btn" onclick="captureAndDetect()" class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-white text-slate-900 px-8 py-4 rounded-2xl font-black shadow-2xl active:scale-95 transition-all z-30">
                游댌 ANALIZAR PLATO
            </button>
        </div>

        <div id="hint" class="hidden text-center text-blue-400 text-[10px] font-bold uppercase animate-bounce">
            쮽alta algo? Toca la foto para a침adirlo manualmente
        </div>

        <div class="bg-slate-900 p-6 rounded-[2.5rem] border border-slate-800">
            <div id="food-list" class="space-y-3 min-h-[60px]">
                <p class="text-slate-600 text-sm italic text-center">Apunta al plato para empezar</p>
            </div>
            <div class="mt-6 pt-4 border-t border-slate-800 flex justify-between items-end">
                <div>
                    <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Total Hidratos</span>
                    <div id="total-hc" class="text-4xl font-black">0g</div>
                </div>
                <div id="dual-alert" class="hidden text-right bg-orange-500/10 p-2 rounded-xl border border-orange-500/30">
                    <span class="text-[9px] text-orange-500 font-black uppercase">丘멆잺 Bolo Dual</span>
                </div>
            </div>
        </div>

        <div class="bg-blue-600 p-6 rounded-[3rem] shadow-xl">
            <div class="flex gap-3">
                <input type="number" id="glucemia" placeholder="mg/dL" class="w-full bg-blue-700 border-none rounded-2xl p-4 text-2xl font-bold text-white placeholder-blue-300 outline-none">
                <button onclick="calcularDosisFinal()" class="bg-white text-blue-600 px-6 rounded-2xl font-black text-xs uppercase">Bolo</button>
            </div>
        </div>
    </div>

    <div id="manual-modal" class="hidden fixed inset-0 z-50 bg-black/95 p-6 overflow-y-auto">
        <h2 class="text-white font-black text-center mb-6">INSERTAR MANUALMENTE</h2>
        <div id="manual-grid" class="grid grid-cols-2 gap-3"></div>
        <button onclick="document.getElementById('manual-modal').classList.add('hidden')" class="w-full mt-8 bg-slate-800 py-4 rounded-xl font-bold">CANCELAR</button>
    </div>

    <div id="result-modal" class="hidden fixed inset-0 z-50 bg-slate-950 flex items-center justify-center p-6">
        <div class="bg-slate-900 border border-slate-800 w-full rounded-[3rem] p-10 text-center">
            <p class="text-slate-500 text-[10px] font-bold uppercase mb-4">Dosis Sugerida (Ratio 7.5)</p>
            <div id="dose-now" class="text-8xl font-black text-white leading-none">0.0</div>
            <div id="dose-delay" class="hidden mt-6 pt-6 border-t border-slate-800">
                <p class="text-blue-400 text-[10px] font-bold uppercase">En 2 horas (Bolo Dual)</p>
                <div id="dose-delay-val" class="text-4xl font-black text-blue-400">0.0</div>
            </div>
            <button onclick="location.reload()" class="w-full mt-10 bg-blue-600 py-4 rounded-2xl font-black">NUEVO ESCANEO</button>
        </div>
    </div>

    <script>
        const RATIO = 7.5;
        const FSI = 33.3;
        const OBJ = 120;
        
        let model;
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let currentPlato = [];

        // DB con mapeo de COCO-SSD e IG
        const FOOD_DB = {
            "pizza": { esp: "Pizza", hc: 65, ig: "Alto", dual: true, icon: "游꼣" },
            "sandwich": { esp: "Sandwich/Burguer", hc: 45, ig: "Medio", dual: true, icon: "游꼢" },
            "apple": { esp: "Manzana", hc: 15, ig: "Bajo", dual: false, icon: "游꼝" },
            "orange": { esp: "Naranja", hc: 12, ig: "Bajo", dual: false, icon: "游꼙" },
            "banana": { esp: "Pl치tano", hc: 22, ig: "Medio", dual: false, icon: "游꼛" },
            "cake": { esp: "Tarta/Dulce", hc: 50, ig: "Alto", dual: true, icon: "游꼻" },
            "hot dog": { esp: "Perrito Caliente", hc: 35, ig: "Alto", dual: true, icon: "游꺐" },
            "broccoli": { esp: "Verdura", hc: 5, ig: "Bajo", dual: false, icon: "游볹" },
            "spaghetti": { esp: "Espaguetis", hc: 55, ig: "Medio", dual: true, icon: "游꼫" },
            "rice": { esp: "Arroz", hc: 45, ig: "Alto", dual: false, icon: "游꼨" },
            "steak": { esp: "Carne/Lomo", hc: 0, ig: "Bajo", dual: false, icon: "游볼" }
        };

        async function init() {
            model = await cocoSsd.load();
            document.getElementById('ai-status').innerText = "IA LISTA";
            document.getElementById('ai-status').className = "text-[9px] bg-green-500/20 text-green-500 px-2 py-1 rounded border border-green-500/30 font-bold";
            
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            
            // Llenar grid manual
            const grid = document.getElementById('manual-grid');
            for(let key in FOOD_DB) {
                grid.innerHTML += `<button onclick="addFood('${key}')" class="bg-slate-800 p-4 rounded-2xl flex flex-col items-center">
                    <span class="text-2xl">${FOOD_DB[key].icon}</span>
                    <span class="text-[10px] font-bold mt-2 uppercase">${FOOD_DB[key].esp}</span>
                </button>`;
            }
        }

        async function captureAndDetect() {
            // Congelar imagen
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            video.style.display = 'none';
            
            // Detectar
            const predictions = await model.detect(canvas);
            
            currentPlato = [];
            predictions.forEach(pred => {
                // Si la IA detecta algo que est치 en nuestra DB de comida
                if (FOOD_DB[pred.class]) {
                    currentPlato.push({...FOOD_DB[pred.class], uid: Date.now() + Math.random()});
                    drawBox(pred.bbox, FOOD_DB[pred.class].esp);
                }
            });

            updateUI();
            document.getElementById('main-btn').style.display = 'none';
            document.getElementById('hint').classList.remove('hidden');
        }

        function drawBox(bbox, label) {
            ctx.strokeStyle = "#3b82f6";
            ctx.lineWidth = 4;
            ctx.strokeRect(...bbox);
            ctx.fillStyle = "#3b82f6";
            ctx.font = "bold 20px Outfit";
            ctx.fillText(label.toUpperCase(), bbox[0], bbox[1] > 20 ? bbox[1] - 10 : 20);
        }

        // Click en canvas para manual
        canvas.addEventListener('click', () => {
            document.getElementById('manual-modal').classList.remove('hidden');
        });

        function addFood(key) {
            currentPlato.push({...FOOD_DB[key], uid: Date.now()});
            document.getElementById('manual-modal').classList.add('hidden');
            updateUI();
        }

        function updateUI() {
            const list = document.getElementById('food-list');
            let total = 0;
            let needsDual = false;
            list.innerHTML = "";

            currentPlato.forEach(item => {
                total += item.hc;
                if(item.dual) needsDual = true;
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-slate-800/50 p-3 rounded-xl border-l-4 border-blue-500">
                        <span class="text-xs font-bold uppercase">${item.icon} ${item.esp} (IG ${item.ig})</span>
                        <span class="font-black text-blue-400">${item.hc}g</span>
                    </div>`;
            });

            document.getElementById('total-hc').innerText = total + "g";
            document.getElementById('dual-alert').style.display = needsDual ? 'block' : 'none';
            window.lastTotalHC = total;
            window.lastDual = needsDual;
        }

        function calcularDosisFinal() {
            const glu = parseFloat(document.getElementById('glucemia').value);
            if(!glu) return alert("Introduce glucemia");

            const dose = window.lastTotalHC / RATIO + (glu > OBJ ? (glu - OBJ)/FSI : 0);
            
            if(window.lastDual && dose > 2) {
                document.getElementById('dose-now').innerText = (Math.round((dose * 0.7) * 2) / 2).toFixed(1);
                document.getElementById('dose-delay').classList.remove('hidden');
                document.getElementById('dose-delay-val').innerText = (Math.round((dose * 0.3) * 2) / 2).toFixed(1);
            } else {
                document.getElementById('dose-now').innerText = (Math.round(dose * 2) / 2).toFixed(1);
                document.getElementById('dose-delay').classList.add('hidden');
            }
            document.getElementById('result-modal').classList.remove('hidden');
        }

        init();
    </script>
</body>
</html>
