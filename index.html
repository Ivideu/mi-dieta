<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Diabetes AI - Segmentación Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;900&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: "Outfit", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-50 min-h-screen">
  <div class="max-w-md mx-auto px-4 py-6 space-y-4">
    <!-- Header -->
    <header class="text-center space-y-1">
      <h1 class="text-2xl font-black tracking-tight">Diabetes AI</h1>
      <p class="text-sm text-slate-300">Segmentación Pro · Raciones · Insulina rápida</p>
    </header>

    <!-- Ajustes personales -->
    <section class="bg-slate-900/70 border border-slate-800 rounded-2xl p-4 space-y-3">
      <h2 class="text-sm font-semibold text-slate-200 uppercase tracking-wide">Ajustes personales</h2>
      <div class="space-y-2">
        <label class="block text-xs text-slate-300">
          Gramos de hidratos por ración
          <input
            id="hcPerPortion"
            type="number"
            value="15"
            class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
          />
        </label>
        <label class="block text-xs text-slate-300">
          Unidades de insulina por gramo de HC
          <input
            id="insulinPerGram"
            type="number"
            step="0.01"
            value="0.1"
            class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
          />
        </label>
      </div>
      <p class="text-[11px] text-slate-400">
        Estos valores deben ser indicados por tu equipo médico. Esta app es una ayuda, no sustituye su criterio.
      </p>
    </section>

    <!-- Buscar alimento -->
    <section class="bg-slate-900/70 border border-slate-800 rounded-2xl p-4 space-y-3">
      <h2 class="text-sm font-semibold text-slate-200 uppercase tracking-wide">Añadir alimento</h2>
      <div class="flex gap-2">
        <input
          id="foodQuery"
          type="text"
          placeholder="Ej: pan, manzana..."
          class="flex-1 rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
        />
        <button
          id="searchFoodBtn"
          class="px-3 py-2 rounded-xl bg-emerald-500 text-xs font-semibold text-slate-950 hover:bg-emerald-400"
        >
          Buscar
        </button>
      </div>

      <ul id="foodResults" class="divide-y divide-slate-800 text-sm max-h-40 overflow-y-auto"></ul>

      <div id="selectedFoodBox" class="hidden items-center gap-2 text-sm">
        <span id="selectedFoodName" class="flex-1 truncate"></span>
        <input
          id="selectedFoodGrams"
          type="number"
          value="100"
          class="w-20 rounded-xl bg-slate-900 border border-slate-700 px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500"
        />
        <span class="text-xs text-slate-400">g</span>
        <button
          id="addFoodBtn"
          class="px-3 py-1 rounded-xl bg-sky-500 text-xs font-semibold text-slate-950 hover:bg-sky-400"
        >
          Añadir
        </button>
      </div>
    </section>

    <!-- Foto del plato -->
    <section class="bg-slate-900/70 border border-slate-800 rounded-2xl p-4 space-y-3">
      <h2 class="text-sm font-semibold text-slate-200 uppercase tracking-wide">Foto del plato</h2>
      <input
        id="plateImageInput"
        type="file"
        accept="image/*"
        capture="environment"
        class="block w-full text-xs text-slate-300 file:mr-3 file:py-1 file:px-3 file:rounded-xl file:border-0 file:text-xs file:font-semibold file:bg-emerald-500 file:text-slate-950 hover:file:bg-emerald-400"
      />
      <p class="text-[11px] text-slate-400">
        La identificación automática del alimento y la cantidad depende del modelo de visión conectado en el backend
        (<code>/api/plate/analyze</code>).
      </p>
      <p id="plateStatus" class="text-[11px] text-slate-400"></p>
    </section>

    <!-- Resumen y cálculo -->
    <section class="bg-slate-900/70 border border-slate-800 rounded-2xl p-4 space-y-3">
      <h2 class="text-sm font-semibold text-slate-200 uppercase tracking-wide">Resumen</h2>
      <ul id="itemsList" class="divide-y divide-slate-800 text-sm max-h-40 overflow-y-auto"></ul>

      <div class="grid grid-cols-3 gap-2 text-xs text-slate-300">
        <div class="bg-slate-900 rounded-xl p-2">
          <p class="text-[11px] text-slate-400">HC totales</p>
          <p id="totalCarbs" class="text-base font-semibold">0.0 g</p>
        </div>
        <div class="bg-slate-900 rounded-xl p-2">
          <p class="text-[11px] text-slate-400">Raciones</p>
          <p id="totalPortions" class="text-base font-semibold">0.0</p>
        </div>
        <div class="bg-slate-900 rounded-xl p-2">
          <p class="text-[11px] text-slate-400">Insulina rápida</p>
          <p id="totalInsulin" class="text-base font-semibold">0.0 U</p>
        </div>
      </div>

      <p class="text-[11px] text-slate-400">
        Cálculo orientativo basado en hidratos de carbono. Ajusta siempre según las indicaciones de tu equipo médico.
      </p>
    </section>
  </div>

  <script>
    // Estado en memoria
    const state = {
      items: [], // { name, grams, carbsPer100g }
      selectedFood: null
    };

    const hcPerPortionInput = document.getElementById("hcPerPortion");
    const insulinPerGramInput = document.getElementById("insulinPerGram");

    const foodQueryInput = document.getElementById("foodQuery");
    const searchFoodBtn = document.getElementById("searchFoodBtn");
    const foodResultsList = document.getElementById("foodResults");

    const selectedFoodBox = document.getElementById("selectedFoodBox");
    const selectedFoodNameSpan = document.getElementById("selectedFoodName");
    const selectedFoodGramsInput = document.getElementById("selectedFoodGrams");
    const addFoodBtn = document.getElementById("addFoodBtn");

    const plateImageInput = document.getElementById("plateImageInput");
    const plateStatus = document.getElementById("plateStatus");

    const itemsList = document.getElementById("itemsList");
    const totalCarbsEl = document.getElementById("totalCarbs");
    const totalPortionsEl = document.getElementById("totalPortions");
    const totalInsulinEl = document.getElementById("totalInsulin");

    function renderItems() {
      itemsList.innerHTML = "";
      state.items.forEach((item, index) => {
        const li = document.createElement("li");
        li.className = "flex items-center justify-between py-1.5";
        li.innerHTML = `
          <div class="flex-1">
            <p class="text-xs font-medium">${item.name}</p>
            <p class="text-[11px] text-slate-400">${item.grams} g · ${item.carbsPer100g} g HC / 100 g</p>
          </div>
          <button data-index="${index}" class="text-[11px] text-rose-400 hover:text-rose-300">Quitar</button>
        `;
        itemsList.appendChild(li);
      });

      itemsList.querySelectorAll("button[data-index]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const idx = Number(btn.getAttribute("data-index"));
          state.items.splice(idx, 1);
          updateTotals();
        });
      });

      updateTotals();
    }

    function updateTotals() {
      const hcPerPortion = Number(hcPerPortionInput.value) || 15;
      const insulinPerGram = Number(insulinPerGramInput.value) || 0;

      const totalCarbs = state.items.reduce(
        (sum, it) => sum + (it.carbsPer100g * it.grams) / 100,
        0
      );
      const portions = hcPerPortion > 0 ? totalCarbs / hcPerPortion : 0;
      const insulin = totalCarbs * insulinPerGram;

      totalCarbsEl.textContent = totalCarbs.toFixed(1) + " g";
      totalPortionsEl.textContent = portions.toFixed(1);
      totalInsulinEl.textContent = insulin.toFixed(1) + " U";
    }

    // Buscar alimentos
    searchFoodBtn.addEventListener("click", async () => {
      const q = foodQueryInput.value.trim();
      if (!q) return;

      foodResultsList.innerHTML = '<li class="py-2 text-xs text-slate-400">Buscando...</li>';

      try {
        const res = await fetch("/api/foods/search?q=" + encodeURIComponent(q));
        const data = await res.json();
        const items = data.items || [];

        if (!items.length) {
          foodResultsList.innerHTML =
            '<li class="py-2 text-xs text-slate-400">Sin resultados</li>';
          return;
        }

        foodResultsList.innerHTML = "";
        items.forEach((f) => {
          const li = document.createElement("li");
          li.className = "py-1.5 px-1 cursor-pointer hover:bg-slate-800/60";
          li.innerHTML = `
            <p class="text-xs font-medium">${f.name}</p>
            <p class="text-[11px] text-slate-400">${f.carbsPer100g} g HC / 100 g</p>
          `;
          li.addEventListener("click", () => {
            state.selectedFood = f;
            selectedFoodNameSpan.textContent = f.name;
            selectedFoodBox.classList.remove("hidden");
          });
          foodResultsList.appendChild(li);
        });
      } catch (err) {
        console.error(err);
        foodResultsList.innerHTML =
          '<li class="py-2 text-xs text-rose-400">Error al buscar alimentos</li>';
      }
    });

    // Añadir alimento seleccionado
    addFoodBtn.addEventListener("click", () => {
      if (!state.selectedFood) return;
      const grams = Number(selectedFoodGramsInput.value) || 0;
      if (grams <= 0) return;

      state.items.push({
        name: state.selectedFood.name,
        grams,
        carbsPer100g: state.selectedFood.carbsPer100g
      });

      state.selectedFood = null;
      selectedFoodBox.classList.add("hidden");
      selectedFoodGramsInput.value = "100";
      renderItems();
    });

    // Foto del plato
    plateImageInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      plateStatus.textContent = "Subiendo y analizando imagen...";
      const formData = new FormData();
      formData.append("image", file);

      try {
        const res = await fetch("/api/plate/analyze", {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        const items = data.items || [];

        if (!items.length) {
          plateStatus.textContent = "No se han detectado alimentos en la imagen.";
          return;
        }

        state.items = items.map((it) => ({
          name: it.name,
          grams: it.grams,
          carbsPer100g: it.carbsPer100g
        }));

        plateStatus.textContent = "Plato analizado correctamente.";
        renderItems();
      } catch (err) {
        console.error(err);
        plateStatus.textContent = "Error analizando la imagen del plato.";
      }
    });

    // Recalcular al cambiar ajustes
    hcPerPortionInput.addEventListener("input", updateTotals);
    insulinPerGramInput.addEventListener("input", updateTotals);
  </script>
</body>
</html>
