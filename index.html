<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diabetes 0.5 Precision - Ivideu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        body { font-family: 'JetBrains Mono', monospace; background-color: #0f172a; color: #e2e8f0; }
        .digital-font { font-family: 'Courier New', Courier, monospace; letter-spacing: -2px; }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <div class="w-full max-w-md space-y-4">
        
        <header class="flex justify-between items-center border-b border-slate-700 pb-2">
            <div>
                <h1 class="text-xl font-black text-blue-500">INSULIN<span class="text-white">CALC</span></h1>
                <p class="text-[10px] text-slate-500">DTI: 54 | PASOS: 0.5 UI</p>
            </div>
            <div class="bg-blue-900/30 border border-blue-500/50 px-2 py-1 rounded text-[10px] text-blue-300">
                MODO PLUMA
            </div>
        </header>

        <div class="relative w-full aspect-square bg-black rounded-3xl overflow-hidden border-2 border-slate-700 shadow-2xl">
            <video id="video" autoplay playsinline class="w-full h-full object-cover opacity-90"></video>
            
            <div class="absolute bottom-0 inset-x-0 p-4 bg-gradient-to-t from-black/90 to-transparent">
                <button onclick="escanearPlato()" class="w-full bg-white text-black py-3 rounded-xl font-bold hover:scale-[1.02] transition-transform shadow-lg active:bg-gray-200">
                    üîç ESCANEAR PLATO
                </button>
            </div>
        </div>

        <div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 flex justify-between items-center">
            <div>
                <p class="text-[10px] text-slate-400 uppercase">Detectado</p>
                <h3 id="food-name" class="text-lg font-bold text-blue-400 truncate w-40">---</h3>
            </div>
            <div class="text-right">
                <p class="text-[10px] text-slate-400 uppercase">Hidratos</p>
                <div class="flex items-baseline justify-end gap-1">
                    <input type="number" id="hc-input" value="0" class="w-16 bg-slate-900 border border-slate-600 rounded text-center font-bold text-white py-1 focus:border-blue-500 outline-none">
                    <span class="text-sm font-bold text-slate-500">g</span>
                </div>
            </div>
        </div>

        <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-lg">
            <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Tu Glucemia (mg/dL)</label>
            <input type="number" id="glucemia" placeholder="Ej: 130" class="w-full bg-slate-900 border-2 border-slate-600 p-4 rounded-xl text-3xl font-bold text-center text-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20 outline-none transition-all placeholder-slate-700">
            
            <button onclick="calcularDosis()" class="w-full mt-4 bg-gradient-to-r from-blue-600 to-indigo-600 py-4 rounded-xl font-black text-xl text-white shadow-xl hover:shadow-blue-500/20 transition-all uppercase tracking-widest">
                Calcular Dosis
            </button>
        </div>

        <div id="resultado-final" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/95 backdrop-blur-sm p-6">
            <div class="bg-slate-900 w-full max-w-sm rounded-[2rem] border border-slate-700 p-6 shadow-2xl relative">
                <button onclick="cerrarModal()" class="absolute top-4 right-4 text-slate-500 hover:text-white text-xl font-bold">‚úï</button>
                
                <h2 class="text-center text-slate-400 text-xs font-bold uppercase tracking-[0.2em] mb-6">DOSIS FINAL SUGERIDA</h2>
                
                <div class="text-center py-4 bg-slate-800/50 rounded-3xl border border-slate-700/50 mb-6">
                    <span id="dosis-total" class="text-8xl font-black text-white digital-font">0.0</span>
                    <span class="block text-blue-500 font-bold text-xl mt-[-10px]">UNIDADES</span>
                </div>

                <div class="space-y-3 text-xs font-mono text-slate-400 border-t border-slate-800 pt-4">
                    <div class="flex justify-between">
                        <span>BOLO COMIDA (Exacto):</span>
                        <span id="info-comida" class="text-white">0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span>CORRECCI√ìN (Exacto):</span>
                        <span id="info-corr" class="text-white">0.00</span>
                    </div>
                    <div class="flex justify-between text-yellow-500 pt-2">
                        <span>AJUSTE PLUMA:</span>
                        <span>Redondeo 0.5</span>
                    </div>
                </div>

                <button onclick="cerrarModal()" class="w-full mt-6 bg-slate-800 hover:bg-slate-700 py-3 rounded-xl font-bold text-white transition-colors">
                    Volver
                </button>
            </div>
        </div>

    </div>

    <script>
        const DTI = 54;
        const OBJETIVO = 120;
        let model;

        // Diccionario visual para el "Lomo Saltado" y platos comunes
        const foods = [
            { id: "LOMO/CARNE+PATATAS", keys: ["burger", "sandwich", "meat", "steak"], hc: 45 },
            { id: "PASTA/ITALIANO", keys: ["pasta", "spaghetti", "macaroni", "noodle"], hc: 60 },
            { id: "ARROZ/PAELLA", keys: ["rice", "risotto", "paella", "biryani"], hc: 60 },
            { id: "PIZZA", keys: ["pizza"], hc: 50 },
            { id: "PATATAS FRITAS", keys: ["fries", "chips", "potato"], hc: 40 },
            { id: "PAN/BOLLERIA", keys: ["bread", "toast", "bakery", "dough"], hc: 20 },
            { id: "FRUTA", keys: ["apple", "banana", "orange", "fruit"], hc: 15 }
        ];

        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('video').srcObject = stream;
                model = await mobilenet.load();
            } catch (e) { console.error("Error c√°mara", e); }
        }

        async function escanearPlato() {
            if(!model) return alert("Cargando IA...");
            const predictions = await model.classify(document.getElementById('video'));
            
            let match = null;
            // L√≥gica de b√∫squeda
            for(let p of predictions) {
                let tag = p.className.toLowerCase();
                match = foods.find(f => f.keys.some(k => tag.includes(k)));
                if(match) break;
            }

            if(match) {
                document.getElementById('food-name').innerText = match.id;
                document.getElementById('hc-input').value = match.hc;
            } else {
                document.getElementById('food-name').innerText = "MIXTO / MANUAL";
                document.getElementById('hc-input').value = 40; // Valor seguro por defecto
            }
        }

        function calcularDosis() {
            const glucemia = parseFloat(document.getElementById('glucemia').value);
            const hc = parseFloat(document.getElementById('hc-input').value);

            if(!glucemia || isNaN(hc)) return alert("Introduce glucemia e hidratos");

            // --- C√ÅLCULOS DTI 54 ---
            const fsi = 1800 / DTI; // 33.33
            const ratio = 500 / DTI; // 9.25

            // 1. C√°lculos exactos (con todos los decimales)
            let uComida = hc / ratio;
            let uCorr = 0;

            if(glucemia > OBJETIVO) {
                uCorr = (glucemia - OBJETIVO) / fsi;
            } else if (glucemia < 70) {
                alert("¬°HIPOGLUCEMIA! Toma az√∫car. NO te pongas insulina todav√≠a.");
                return;
            }

            let sumaExacta = uComida + uCorr;

            // 2. L√ìGICA DE REDONDEO A 0.5
            // Multiplicamos por 2, redondeamos al entero, dividimos por 2
            // Ej: 6.23 -> 12.46 -> 12 -> 6.0
            // Ej: 6.35 -> 12.70 -> 13 -> 6.5
            let sumaRedondeada = Math.round(sumaExacta * 2) / 2;

            // 3. Mostrar Resultados
            document.getElementById('resultado-final').classList.remove('hidden');
            
            // Si es entero (ej: 6), le a√±adimos ".0" para que se vea profesional
            document.getElementById('dosis-total').innerText = Number.isInteger(sumaRedondeada) ? sumaRedondeada + ".0" : sumaRedondeada;
            
            document.getElementById('info-comida').innerText = uComida.toFixed(2) + " UI";
            document.getElementById('info-corr').innerText = uCorr.toFixed(2) + " UI";
        }

        function cerrarModal() {
            document.getElementById('resultado-final').classList.add('hidden');
        }

        init();
    </script>
</body>
</html>
