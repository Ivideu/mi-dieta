<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diabetes AI Ultra - Ivideu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen">

    <div class="max-w-md mx-auto p-4 space-y-6">
        <header class="text-center py-6">
            <h1 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-green-400">DIABETES VISION PRO</h1>
            <p class="text-gray-400 text-xs tracking-widest uppercase">Motor de Red Neuronal Profunda</p>
        </header>

        <div class="relative rounded-[3rem] overflow-hidden border-4 border-slate-800 shadow-2xl aspect-square bg-black">
            <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
            <div id="scan-line" class="absolute top-0 left-0 w-full h-1 bg-blue-500 shadow-[0_0_15px_blue] animate-scan"></div>
            
            <div class="absolute bottom-6 left-0 right-0 flex justify-center px-8">
                <button onclick="superEscaner()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-2xl font-black shadow-xl transition-all active:scale-95 flex items-center justify-center gap-3">
                    <span>⚡ ESCANEO IA PROFUNDO</span>
                </button>
            </div>
        </div>

        <div class="bg-slate-800 rounded-3xl p-6 border border-slate-700">
            <div class="flex items-center gap-4 mb-4">
                <div class="bg-blue-500/20 p-3 rounded-2xl">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                </div>
                <div>
                    <h3 id="label-alimento" class="text-xl font-bold text-white uppercase tracking-tight">Esperando plato...</h3>
                    <p id="label-hc" class="text-green-400 font-bold text-sm">0g Hidratos Detectados</p>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Glucemia Actual</label>
                    <input type="number" id="glucemia" placeholder="mg/dL" class="w-full bg-slate-900 border-none p-4 rounded-2xl text-2xl font-bold focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <button onclick="calcularInsulina()" class="w-full bg-green-600 py-4 rounded-2xl font-black text-lg hover:bg-green-500 shadow-lg shadow-green-900/20 transition-all">
                    CALCULAR BOLO
                </button>
            </div>
        </div>

        <div id="resultado" class="hidden animate-bounce-in">
            <div class="bg-white rounded-[2.5rem] p-8 text-slate-900 shadow-2xl relative">
                <p class="text-xs font-black text-slate-400 uppercase mb-1">Dosis Recomendada (DTI 54)</p>
                <div class="flex items-baseline gap-2">
                    <h2 id="total-ui" class="text-7xl font-black text-slate-900">0.0</h2>
                    <span class="text-2xl font-bold text-blue-600">UI</span>
                </div>
                <div class="mt-6 flex gap-4 text-xs font-bold text-slate-500 border-t pt-4">
                    <div class="bg-slate-100 p-2 rounded-lg flex-1 text-center">Raciones: <span id="res-rac" class="text-slate-900">0</span></div>
                    <div class="bg-slate-100 p-2 rounded-lg flex-1 text-center">FSI (Corr): <span id="res-fsi" class="text-slate-900">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
        .animate-scan { animation: scan 2s linear infinite; }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes bounceIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>

    <script>
        const DTI = 54;
        const OBJETIVO = 120;
        let model;
        let hcFinal = 0;

        // ESTA ES LA "BASE DE DATOS INFINITA" (Categorización por Familias de Imágenes)
        const FAMILIAS_COMIDA = [
            { hc: 50, keys: ["pizza", "dough", "pie", "bread", "sandwich", "burger", "pan", "bollo", "flour"] },
            { hc: 30, keys: ["pasta", "spaghetti", "noodle", "macaroni", "lasagna", "ravioli"] },
            { hc: 28, keys: ["rice", "paella", "risotto", "sushi", "grain", "cereal"] },
            { hc: 20, keys: ["potato", "chip", "fries", "tuber", "patata", "frita"] },
            { hc: 15, keys: ["fruit", "apple", "banana", "orange", "pear", "grape", "strawberry"] },
            { hc: 12, keys: ["legume", "bean", "lentil", "chickpea", "stew", "guiso"] },
            { hc: 5,  keys: ["vegetable", "salad", "lettuce", "broccoli", "spinach", "soup"] },
            { hc: 40, keys: ["cake", "dessert", "cookie", "sweet", "chocolate", "pastry"] }
        ];

        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('video').srcObject = stream;
                model = await mobilenet.load();
                console.log("IA Lista");
            } catch (e) {
                alert("Error: Activa la cámara.");
            }
        }

        async function superEscaner() {
            if(!model) return;
            const predictions = await model.classify(document.getElementById('video'));
            
            let detectado = false;
            // Buscamos en las predicciones de millones de imágenes de MobileNet
            for(let p of predictions) {
                const nombreIA = p.className.toLowerCase();
                
                for(let familia of FAMILIAS_COMIDA) {
                    if(familia.keys.some(k => nombreIA.includes(k))) {
                        // Asignamos HC según familia y una ración estándar
                        hcFinal = familia.hc * 1.5; // Estimación ración media 150g
                        document.getElementById('label-alimento').innerText = nombreIA.split(',')[0];
                        document.getElementById('label-hc').innerText = hcFinal.toFixed(0) + "g HC Detectados";
                        detectado = true;
                        break;
                    }
                }
                if(detectado) break;
            }

            if(!detectado) {
                document.getElementById('label-alimento').innerText = "Plato no identificado";
                document.getElementById('label-hc').innerText = "Introduce HC manualmente";
                hcFinal = prompt("La IA no está segura. ¿Cuántos gramos de HC aproximas?") || 0;
            }
        }

        function calcularInsulina() {
            const glucemia = parseFloat(document.getElementById('glucemia').value);
            if(!glucemia || hcFinal === 0) return alert("Faltan datos (Glucemia o Escaneo)");

            // FÓRMULAS EXACTAS DTI 54
            const raciones = hcFinal / 10;
            const fsi = 1800 / DTI; // 33.3
            const ratio = 500 / DTI; // 9.25
            
            const uComida = hcFinal / ratio;
            const uCorr = glucemia > OBJETIVO ? (glucemia - OBJETIVO) / fsi : 0;
            const total = uComida + uCorr;

            document.getElementById('resultado').classList.remove('hidden');
            document.getElementById('total-ui').innerText = total.toFixed(1);
            document.getElementById('res-rac').innerText = raciones.toFixed(1);
            document.getElementById('res-fsi').innerText = uCorr.toFixed(1);

            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        init();
    </script>
</body>
</html>
