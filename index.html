<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diabetes Expert - Precision 0.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #111827; color: white; }
        .border-gradient { border: 4px solid; border-image-slice: 1; border-image-source: linear-gradient(to left, #3b82f6, #8b5cf6); }
    </style>
</head>
<body class="min-h-screen p-4 pb-20">

    <div class="max-w-md mx-auto space-y-6">
        <header class="flex justify-between items-end border-b border-gray-700 pb-4">
            <div>
                <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-500">DIABETES PRO</h1>
                <p class="text-xs text-gray-400 font-mono">DTI: 54 | AUTO-CORRECCI√ìN DE IMAGEN</p>
            </div>
            <div class="text-right">
                <span class="bg-blue-900 text-blue-200 text-[10px] font-bold px-2 py-1 rounded">DOSIS 0.5 UI</span>
            </div>
        </header>

        <div class="relative rounded-3xl overflow-hidden shadow-2xl bg-black aspect-[4/3] border-2 border-blue-600">
            <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
            
            <button onclick="analizarPlato()" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-white text-black px-8 py-3 rounded-full font-black text-sm shadow-xl hover:scale-105 transition-transform flex items-center gap-2">
                <span>üëÅÔ∏è IDENTIFICAR PLATO</span>
            </button>
        </div>

        <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 space-y-2">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest">Interpretaci√≥n IA</p>
                    <h2 id="nombre-plato" class="text-xl font-black text-blue-400 uppercase leading-none mt-1">ENFOCA TU COMIDA</h2>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest">Raciones (10g)</p>
                    <p id="txt-raciones" class="text-2xl font-black text-white">0.0 R</p>
                </div>
            </div>
            <p id="subtitulo-plato" class="text-xs text-gray-500 italic">Espera a detectar...</p>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="bg-gray-800 p-4 rounded-2xl">
                <label class="text-[10px] font-bold text-gray-400 uppercase">Glucemia</label>
                <input type="number" id="glucemia" placeholder="mg/dL" class="w-full bg-transparent text-2xl font-bold outline-none mt-1 placeholder-gray-600">
            </div>
            <div class="bg-gray-800 p-4 rounded-2xl">
                <label class="text-[10px] font-bold text-gray-400 uppercase">Ajuste HC (g)</label>
                <input type="number" id="manual-hc" placeholder="Auto" class="w-full bg-transparent text-2xl font-bold outline-none mt-1 placeholder-gray-600 text-blue-400">
            </div>
        </div>

        <button onclick="calcular()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 py-4 rounded-2xl font-black text-xl shadow-lg active:opacity-90">
            CALCULAR INSULINA
        </button>

        <div id="result-box" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-gray-900 w-full max-w-sm rounded-[2rem] p-8 border border-gray-700 shadow-2xl relative">
                <button onclick="cerrarModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white">‚úï</button>
                
                <p class="text-center text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">DOSIS TOTAL SUGERIDA</p>
                
                <div class="text-center mb-8">
                    <span id="res-total" class="text-8xl font-black text-white tracking-tighter">0.0</span>
                    <span class="text-2xl text-blue-500 font-bold block mt-[-10px]">UNIDADES</span>
                </div>

                <div class="space-y-3 text-sm font-medium text-gray-400 border-t border-gray-800 pt-4">
                    <div class="flex justify-between">
                        <span>Comida (Ratio 1.1):</span>
                        <span id="res-comida" class="text-white">0.0 u</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Correcci√≥n (FSI 33):</span>
                        <span id="res-corr" class="text-white">0.0 u</span>
                    </div>
                    <div class="flex justify-between text-xs italic text-gray-600 mt-2">
                        <span>*Redondeado a pasos de 0.5</span>
                    </div>
                </div>
                
                <button onclick="cerrarModal()" class="w-full mt-6 bg-gray-800 hover:bg-gray-700 py-3 rounded-xl font-bold">Cerrar</button>
            </div>
        </div>

    </div>

    <script>
        const DTI = 54;
        const OBJETIVO = 120;
        let model;
        let gramsHC = 0;

        // MAPA DE TRADUCCI√ìN INTELIGENTE
        // Convierte lo que la IA "ve" (Conceptos visuales) en lo que realmente "es" (Platos Reales)
        // Lomo Saltado = Carne + Patatas fritas. La IA suele ver "Cheeseburger" o "Hot Pot".
        const DICCIONARIO_VISUAL = [
            { tags: ["cheeseburger", "burger", "sandwich", "hotdog"], name: "CARNE CON PATATAS / LOMO", hc: 45, raciones: 4.5 },
            { tags: ["french fries", "fries"], name: "PATATAS FRITAS (RACI√ìN)", hc: 40, raciones: 4.0 },
            { tags: ["steak", "meat", "potpie", "stew", "goulash"], name: "GUISO DE CARNE/PATATA", hc: 35, raciones: 3.5 },
            { tags: ["rice", "fried rice", "risotto", "paella"], name: "ARROZ / SALTEADO", hc: 50, raciones: 5.0 },
            { tags: ["pasta", "spaghetti", "carbonara", "noodle"], name: "PASTA / TALLARINES", hc: 60, raciones: 6.0 },
            { tags: ["pizza", "flatbread"], name: "PIZZA (2 PORCIONES)", hc: 50, raciones: 5.0 },
            { tags: ["mashed", "potato"], name: "PUR√â DE PATATA", hc: 30, raciones: 3.0 },
            { tags: ["bread", "toast", "bakery"], name: "PAN / BOLLER√çA", hc: 20, raciones: 2.0 }
        ];

        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('video').srcObject = stream;
                model = await mobilenet.load();
                console.log("Sistema cargado");
            } catch (e) {
                alert("Activa la c√°mara en los ajustes del navegador.");
            }
        }

        async function analizarPlato() {
            if (!model) return;
            const video = document.getElementById('video');
            document.getElementById('subtitulo-plato').innerText = "Escaneando texturas...";
            
            // 1. Obtener predicciones crudas de la IA
            const predictions = await model.classify(video);
            
            let encontrado = false;
            let mejorCoincidencia = null;

            // 2. Buscar en nuestro Diccionario Visual Inteligente
            for (let p of predictions) {
                const iaTag = p.className.toLowerCase();
                
                // Buscamos si alguna etiqueta de la IA coincide con nuestras categor√≠as
                for (let plato of DICCIONARIO_VISUAL) {
                    if (plato.tags.some(tag => iaTag.includes(tag))) {
                        mejorCoincidencia = plato;
                        encontrado = true;
                        break;
                    }
                }
                if (encontrado) break;
            }

            // 3. Mostrar Resultado Interpretado
            if (encontrado) {
                gramsHC = mejorCoincidencia.hc;
                document.getElementById('nombre-plato').innerText = mejorCoincidencia.name;
                document.getElementById('subtitulo-plato').innerText = `Detectado patr√≥n: ${predictions[0].className.split(',')[0]}`;
                document.getElementById('txt-raciones').innerText = mejorCoincidencia.raciones.toFixed(1) + " R";
                document.getElementById('manual-hc').value = gramsHC;
            } else {
                // Fallback si no est√° seguro
                gramsHC = 40; // Valor medio seguro
                document.getElementById('nombre-plato').innerText = "PLATO MIXTO";
                document.getElementById('subtitulo-plato').innerText = "No reconocido con certeza. Asumiendo plato medio.";
                document.getElementById('txt-raciones').innerText = "4.0 R";
                document.getElementById('manual-hc').value = 40;
            }
        }

        function calcular() {
            let glucemia = parseFloat(document.getElementById('glucemia').value);
            let hcInput = parseFloat(document.getElementById('manual-hc').value);

            if (!glucemia) return alert("Introduce tu glucemia");
            if (!hcInput) hcInput = gramsHC; // Usar valor de IA si el input est√° vac√≠o

            // --- F√ìRMULAS DTI 54 ---
            const fsi = 1800 / DTI; // 33.33
            const ratio = 500 / DTI; // 9.25 g/u

            // C√°lculo exacto
            let dosisComida = hcInput / ratio;
            let dosisCorreccion = 0;
            
            if (glucemia > OBJETIVO) {
                dosisCorreccion = (glucemia - OBJETIVO) / fsi;
            }

            let totalExacto = dosisComida + dosisCorreccion;
            
            // --- REDONDEO A 0.5 (CRUCIAL) ---
            // Multiplicamos por 2, redondeamos al entero, y dividimos por 2
            let totalRedondeado = Math.round(totalExacto * 2) / 2;
            
            // Evitar negativos
            if (totalRedondeado < 0) totalRedondeado = 0;

            // Mostrar
            document.getElementById('res-total').innerText = totalRedondeado.toFixed(1);
            document.getElementById('res-comida').innerText = dosisComida.toFixed(1) + " u";
            document.getElementById('res-corr').innerText = dosisCorreccion.toFixed(1) + " u";
            
            document.getElementById('result-box').classList.remove('hidden');
        }

        function cerrarModal() {
            document.getElementById('result-box').classList.add('hidden');
        }

        init();
    </script>
</body>
</html>
