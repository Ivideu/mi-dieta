<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diabetes AI Pro - Ivideu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
</head>
<body class="bg-black text-white min-h-screen font-sans">

    <div class="max-w-md mx-auto p-4 space-y-4">
        <header class="flex justify-between items-center py-2 border-b border-gray-800">
            <h1 class="text-xl font-black text-blue-500">DIABETES <span class="text-white font-light">VISION</span></h1>
            <div class="text-[10px] text-right text-gray-500">DTI: 54<br>RATIO: 1.1u/R</div>
        </header>

        <div class="relative rounded-[2rem] overflow-hidden bg-gray-900 aspect-video border-2 border-blue-600 shadow-[0_0_20px_rgba(37,99,235,0.3)]">
            <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
            <div id="scanner-line" class="absolute inset-x-0 top-0 h-1 bg-blue-400 shadow-[0_0_10px_blue] animate-bounce"></div>
            <button onclick="analizarFoto()" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-blue-600 px-8 py-3 rounded-full font-black text-sm shadow-2xl active:scale-95 transition-all">
                游닞 ANALIZAR PLATO
            </button>
        </div>

        <div class="bg-gray-900 p-5 rounded-3xl border border-gray-800 space-y-3">
            <div class="flex justify-between items-center">
                <span id="txt-alimento" class="text-lg font-bold text-gray-300 italic text-sm">Esperando imagen...</span>
                <span id="txt-hc" class="text-2xl font-black text-green-400">0g <span class="text-xs">HC</span></span>
            </div>
            <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                <button onclick="setHC(60, 'Pasta/Arroz')" class="bg-gray-800 px-4 py-2 rounded-xl text-[10px] font-bold whitespace-nowrap border border-gray-700">游꼫 PASTA/ARROZ</button>
                <button onclick="setHC(50, 'Legumbres')" class="bg-gray-800 px-4 py-2 rounded-xl text-[10px] font-bold whitespace-nowrap border border-gray-700">游 LEGUMBRES</button>
                <button onclick="setHC(40, 'Pan/Pizza')" class="bg-gray-800 px-4 py-2 rounded-xl text-[10px] font-bold whitespace-nowrap border border-gray-700">游꼣 PAN/PIZZA</button>
                <button onclick="setHC(20, 'Fruta/Postre')" class="bg-gray-800 px-4 py-2 rounded-xl text-[10px] font-bold whitespace-nowrap border border-gray-700">游꼝 FRUTA</button>
            </div>
        </div>

        <div class="bg-gray-900 p-6 rounded-3xl space-y-4">
            <div class="relative">
                <label class="text-[10px] font-bold text-gray-500 uppercase absolute -top-2 left-3 bg-gray-900 px-2 italic">Glucemia Actual</label>
                <input type="number" id="glucemia" placeholder="mg/dL" class="w-full bg-transparent border-2 border-gray-700 p-4 rounded-2xl text-2xl font-bold focus:border-blue-500 transition-all outline-none">
            </div>
            
            <button onclick="calcularInsulina()" class="w-full bg-blue-600 py-5 rounded-2xl font-black text-xl shadow-lg hover:bg-blue-500 active:scale-95 transition-all uppercase tracking-widest">
                Calcular Bolo
            </button>
        </div>

        <div id="res-card" class="hidden bg-gradient-to-br from-blue-600 to-blue-800 p-8 rounded-[2.5rem] shadow-2xl relative overflow-hidden">
            <div class="relative z-10">
                <p class="text-xs font-bold text-blue-200 uppercase mb-1">Dosis Recomendada:</p>
                <div class="flex items-baseline gap-2">
                    <h2 id="ui-total" class="text-7xl font-black">0.0</h2>
                    <span class="text-2xl font-bold text-white">UI</span>
                </div>
                <div class="mt-4 flex gap-4 text-[10px] font-bold text-blue-200 border-t border-blue-400/30 pt-4">
                    <div class="bg-black/20 p-2 rounded-lg flex-1">BOLO COMIDA: <span id="ui-comida" class="text-white">0</span></div>
                    <div class="bg-black/20 p-2 rounded-lg flex-1">CORRECCI칍N: <span id="ui-corr" class="text-white">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DTI = 54;
        const OBJETIVO = 120;
        let model;
        let hcGlobal = 0;

        // Base de datos de Visi칩n para Europa (Millones de im치genes representadas en estos tags)
        const dbEurope = [
            { hc: 60, tags: ["rice", "paella", "risotto", "pasta", "spaghetti", "macaroni", "noodle", "pizza"] },
            { hc: 40, tags: ["bread", "sandwich", "baguette", "bun", "hamburger", "potato", "fries"] },
            { hc: 25, tags: ["bean", "lentil", "chickpea", "stew", "legume"] },
            { hc: 15, tags: ["apple", "banana", "orange", "fruit", "pear", "yogurt"] },
            { hc: 5,  tags: ["salad", "vegetable", "soup", "broccoli", "spinach", "egg", "meat", "fish"] }
        ];

        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('video').srcObject = stream;
                model = await mobilenet.load();
                document.getElementById('txt-alimento').innerText = "C치mara e IA Listas";
            } catch (e) {
                alert("Error: Activa los permisos de c치mara.");
            }
        }

        async function analizarFoto() {
            if(!model) return;
            document.getElementById('txt-alimento').innerText = "Analizando plato...";
            const predictions = await model.classify(document.getElementById('video'));
            
            let detected = false;
            for(let p of predictions) {
                const name = p.className.toLowerCase();
                for(let item of dbEurope) {
                    if(item.tags.some(t => name.includes(t))) {
                        setHC(item.hc, name.split(',')[0]);
                        detected = true;
                        break;
                    }
                }
                if(detected) break;
            }
            if(!detected) {
                document.getElementById('txt-alimento').innerText = "No estoy segura. Elige abajo:";
            }
        }

        function setHC(val, name) {
            hcGlobal = val;
            document.getElementById('txt-hc').innerText = val + "g HC";
            document.getElementById('txt-alimento').innerText = name.toUpperCase();
        }

        function calcularInsulina() {
            const glu = parseFloat(document.getElementById('glucemia').value);
            if(isNaN(glu) || hcGlobal === 0) return alert("Falta Glucemia o elegir alimento");

            // F칍RMULAS EXACTAS DTI 54 (P치g 10-11 PDF)
            const fsi = 1800 / DTI; // 33.3 (Baja 33mg por cada unidad)
            const ratio = 500 / DTI; // 9.25 (1 unidad por cada 9.2g de HC)
            
            const uComida = hcGlobal / ratio;
            const uCorr = glu > OBJETIVO ? (glu - OBJETIVO) / fsi : 0;
            const total = uComida + uCorr;

            document.getElementById('res-card').classList.remove('hidden');
            document.getElementById('ui-total').innerText = total.toFixed(1);
            document.getElementById('ui-comida').innerText = uComida.toFixed(1) + "u";
            document.getElementById('ui-corr').innerText = uCorr.toFixed(1) + "u";

            if(glu < 70) alert("춰ALERTA HIPOGLUCEMIA! Regla del 15 (PDF P치g 3). No pongas insulina.");
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        init();
    </script>
</body>
</html>
