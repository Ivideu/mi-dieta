<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Diabetes AI - Ratio Ajustado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
</head>
<body class="bg-slate-950 text-slate-100 p-4">

    <div class="max-w-md mx-auto space-y-4">
        <header class="bg-slate-900 p-4 rounded-3xl border border-slate-800">
            <h1 class="text-xl font-black text-blue-500 italic">CONTROL <span class="text-white">GLUCÃ‰MICO</span></h1>
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Ratio Actualizado: 7.5 (Moderado)</p>
        </header>

        <div class="relative rounded-[2.5rem] overflow-hidden border-2 border-slate-800 aspect-square">
            <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
            <button onclick="procesarPlato()" class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-blue-600 px-10 py-4 rounded-2xl font-black shadow-2xl active:scale-95 transition-all">
                ðŸ“¸ ANALIZAR
            </button>
        </div>

        <div class="bg-slate-900 p-6 rounded-[2rem] border border-slate-800 shadow-xl">
            <div id="lista-alimentos" class="space-y-3 mb-4">
                <p class="text-slate-600 text-sm text-center italic">Analiza el plato para calcular...</p>
            </div>
            <div class="flex justify-between items-center pt-4 border-t border-slate-800">
                <span class="text-slate-400 font-bold text-sm uppercase">Total HC:</span>
                <span id="total-hc" class="text-3xl font-black text-white">0g</span>
            </div>
        </div>

        <div class="bg-blue-600 p-6 rounded-[2.5rem] shadow-xl space-y-4">
            <input type="number" id="glucemia" placeholder="Glucemia actual" class="w-full bg-blue-700 border-none p-4 rounded-2xl text-2xl font-bold text-white placeholder-blue-300 outline-none">
            <button onclick="calcularDosis()" class="w-full bg-white text-blue-600 py-5 rounded-2xl font-black text-xl uppercase">Calcular Bolo</button>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-slate-950/98 flex items-center justify-center z-50 p-6">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-sm rounded-[3rem] p-10 text-center shadow-2xl">
            <p class="text-slate-500 text-[10px] font-black uppercase mb-4">Nueva Dosis Sugerida (0.5)</p>
            <div class="py-10 bg-slate-800/50 rounded-[2.5rem] border border-slate-700 mb-8">
                <span id="ui-final" class="text-9xl font-black text-white">0.0</span>
                <span class="block text-blue-500 font-bold text-2xl mt-2 italic">Unidades</span>
            </div>
            <button onclick="document.getElementById('modal').classList.add('hidden')" class="w-full bg-blue-600 py-4 rounded-2xl font-black">CERRAR</button>
        </div>
    </div>

    <script>
        // CAMBIO DE RATIO: Subimos el valor para bajar la dosis de insulina
        const RATIO = 7.5; 
        const FSI = 33.3; 
        const OBJETIVO = 120;
        
        let net;
        let gramosTotales = 0;

        const DB = {
            "fries": { esp: "Patatas Fritas", hc: 40 },
            "potato": { esp: "Patata", hc: 20 },
            "rice": { esp: "Arroz", hc: 45 },
            "pizza": { esp: "Pizza", hc: 50 },
            "hamburger": { esp: "Hamburguesa", hc: 40 },
            "bread": { esp: "Pan", hc: 25 },
            "pasta": { esp: "Pasta", hc: 50 },
            "steak": { esp: "Carne", hc: 0 },
            "chicken": { esp: "Pollo", hc: 0 }
        };

        async function init() {
            net = await mobilenet.load();
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            document.getElementById('video').srcObject = stream;
        }

        async function procesarPlato() {
            const predictions = await net.classify(document.getElementById('video'));
            const lista = document.getElementById('lista-alimentos');
            lista.innerHTML = "";
            gramosTotales = 0;
            let encontrados = new Set();

            predictions.forEach(p => {
                const tag = p.className.toLowerCase();
                for (let key in DB) {
                    if (tag.includes(key) && !encontrados.has(key)) {
                        gramosTotales += DB[key].hc;
                        encontrados.add(key);
                        lista.innerHTML += `
                            <div class="flex justify-between items-center bg-slate-800/50 p-3 rounded-2xl">
                                <span class="text-xs font-bold uppercase">${DB[key].esp}</span>
                                <span class="font-black text-blue-400">${DB[key].hc}g</span>
                            </div>`;
                    }
                }
            });

            if(gramosTotales === 0) {
                gramosTotales = 40; // Valor por defecto
                lista.innerHTML = "<p class='text-center text-xs text-slate-500'>Plato Mixto EstÃ¡ndar Detectado</p>";
            }
            document.getElementById('total-hc').innerText = gramosTotales + "g";
        }

        function calcularDosis() {
            const glu = parseFloat(document.getElementById('glucemia').value);
            if (!glu) return alert("Indica tu glucemia");

            let uComida = gramosTotales / RATIO;
            let uCorr = glu > OBJETIVO ? (glu - OBJETIVO) / FSI : 0;
            let total = Math.round((uComida + uCorr) * 2) / 2;

            document.getElementById('ui-final').innerText = total.toFixed(1);
            document.getElementById('modal').classList.remove('hidden');
        }

        init();
    </script>
</body>
</html>
