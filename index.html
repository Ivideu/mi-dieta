<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diabetes Helper - Ivideu AI Cam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.13.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        input:focus, button:focus { outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.45); }
        .camera-container {
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 Aspect Ratio */
            background-color: #000;
            border-radius: 1.5rem;
            overflow: hidden;
        }
        .camera-video {
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Reflejo para que parezca un espejo */
        }
        .camera-overlay {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .camera-button {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s;
        }
        .camera-button:hover { background-color: #2563eb; /* blue-600 */ }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4 text-slate-800">

    <div class="max-w-md mx-auto space-y-6">
        <header class="text-center py-4">
            <h1 class="text-3xl font-extrabold text-blue-700">Diabetes AI Cam</h1>
            <p class="text-slate-500 text-sm">C√°lculo inteligente con visi√≥n artificial</p>
        </header>

        <div class="bg-white p-4 rounded-3xl shadow-xl border border-blue-200">
            <h2 class="text-lg font-bold mb-4 text-blue-600">¬øQu√© vas a comer?</h2>
            <div class="camera-container mb-4">
                <video id="webcam" autoplay playsinline class="camera-video"></video>
                <canvas id="canvas" class="hidden"></canvas>
                <div class="camera-overlay">
                    <button id="captureButton" class="camera-button">
                        üì∏ Detectar Plato
                    </button>
                </div>
            </div>
            <p id="detection-status" class="text-center text-sm text-slate-600 italic mb-2">Cargando IA...</p>
            <p id="estimated-hc" class="text-center text-lg font-semibold text-green-700 hidden">
                HC Estimados: <span id="hc-value">0</span>g
            </p>
            <p class="text-xs text-red-500 text-center mt-2">
                ‚ö†Ô∏è **¬°IMPORTANTE!** La IA estima los HC. Confirma los gramos o las raciones con tu m√©dico.
            </p>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Mi Configuraci√≥n</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-semibold mb-1">DTI (Total Insulina/D√≠a)</label>
                    <input type="number" id="dti" value="54" readonly class="w-full border border-slate-300 p-2 rounded-lg bg-slate-100 text-slate-600 cursor-not-allowed">
                </div>
                <div>
                    <label class="block text-xs font-semibold mb-1">Objetivo (mg/dL)</label>
                    <input type="number" id="objetivo" value="120" class="w-full border border-slate-300 p-2 rounded-lg bg-slate-50">
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-md border-t-4 border-blue-500">
            <h2 class="text-lg font-bold mb-4 text-blue-600">Mi Glucemia Actual</h2>
            <div>
                <label class="block text-sm font-medium mb-1">Glucemia Actual (mg/dL)</label>
                <input type="number" id="glucemia" placeholder="Ej: 160" class="w-full text-lg border-slate-300 p-3 rounded-xl border">
            </div>

            <button onclick="calcularDosis()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition-all shadow-lg active:scale-95 mt-6">
                CALCULAR DOSIS MANUAL
            </button>
        </div>

        <div id="resultado" class="hidden transform transition-all duration-300 ease-in-out">
            <div class="bg-white p-6 rounded-2xl shadow-xl border-2 border-green-500 relative overflow-hidden">
                <div id="alerta-hipo" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm font-bold animate-pulse">
                    ‚ö†Ô∏è ¬°GLUCEMIA BAJA! Aplica regla del 15.
                </div>

                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-slate-500 text-sm">Dosis Total Recomendada</p>
                        <h2 id="total-ui" class="text-5xl font-black text-green-700">0.0 <span class="text-xl">UI</span></h2>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-slate-700" id="txt-raciones">0 Raciones</p>
                    </div>
                </div>

                <div class="border-t border-slate-200 pt-4 space-y-2 text-sm text-slate-600">
                    <div class="flex justify-between">
                        <span>Bolo por Comida (Ratio):</span>
                        <span id="ui-comida" class="font-mono font-bold">0.0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Bolo Corrector (FSI):</span>
                        <span id="ui-correccion" class="font-mono font-bold">0.0</span>
                    </div>
                </div>
            </div>
        </div>

        <p class="text-[10px] text-slate-400 text-center px-4">
            ADVERTENCIA: Esta app es un prototipo. Los c√°lculos deben ser supervisados por un m√©dico. No tomes decisiones m√©dicas basadas √∫nicamente en esta herramienta.
        </p>
    </div>

    <script>
        // --- CONFIGURACI√ìN DE IA Y ALIMENTOS ---
        let mobileNetModel;
        const webcam = document.getElementById('webcam');
        const captureButton = document.getElementById('captureButton');
        const detectionStatus = document.getElementById('detection-status');
        const estimatedHcDisplay = document.getElementById('estimated-hc');
        const hcValueSpan = document.getElementById('hc-value');

        // Base de datos simplificada de alimentos con HC por 100g (extra√≠do de tu PDF y valores comunes)
        // Usaremos un "peso_estimado_g" como base, pero el usuario debe ser consciente de la imprecisi√≥n.
        const foodDatabase = [
            { name: "rice", keywords: ["rice", "arroz"], hc_100g: 28, peso_estimado_g: 150 }, // Arroz cocido
            { name: "bread", keywords: ["bread", "pan", "tostada"], hc_100g: 50, peso_estimado_g: 50 }, // Pan
            { name: "apple", keywords: ["apple", "manzana"], hc_100g: 14, peso_estimado_g: 150 }, // Manzana
            { name: "potato", keywords: ["potato", "patata", "papas"], hc_100g: 17, peso_estimado_g: 100 }, // Patata cocida
            { name: "pasta", keywords: ["pasta", "espagueti", "macarrones"], hc_100g: 30, peso_estimado_g: 150 }, // Pasta cocida
            { name: "milk", keywords: ["milk", "leche"], hc_100g: 5, peso_estimado_g: 200 }, // Leche
            { name: "yogurt", keywords: ["yogurt", "yogur"], hc_100g: 5, peso_estimado_g: 125 }, // Yogur
            { name: "banana", keywords: ["banana", "platano"], hc_100g: 23, peso_estimado_g: 120 }, // Pl√°tano
            { name: "orange", keywords: ["orange", "naranja"], hc_100g: 12, peso_estimado_g: 150 }, // Naranja
            { name: "lentils", keywords: ["lentils", "lentejas"], hc_100g: 15, peso_estimado_g: 100 }, // Lentejas cocidas
            { name: "chickpeas", keywords: ["chickpeas", "garbanzos"], hc_100g: 18, peso_estimado_g: 100 }, // Garbanzos cocidos
        ];

        let estimatedHC = 0; // Variable para almacenar los HC estimados por la IA

        // Inicializar la c√°mara y el modelo de IA
        async function setupCameraAndModel() {
            try {
                // Cargar MobileNet
                detectionStatus.innerText = "Cargando modelo de IA...";
                mobileNetModel = await mobilenet.load();
                detectionStatus.innerText = "Modelo de IA cargado.";

                // Iniciar c√°mara
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                webcam.srcObject = stream;
                detectionStatus.innerText = "C√°mara lista. Enfoca tu plato y pulsa 'Detectar Plato'.";
            } catch (error) {
                console.error("Error al iniciar c√°mara o cargar modelo:", error);
                detectionStatus.innerText = "Error: No se pudo iniciar la c√°mara o cargar el modelo. (Puede que necesites HTTPS o permisos)";
                captureButton.disabled = true;
            }
        }

        // Funci√≥n para capturar imagen y detectar alimentos
        captureButton.addEventListener('click', async () => {
            if (!mobileNetModel) {
                alert("El modelo de IA no est√° cargado a√∫n. Por favor, espera.");
                return;
            }
            if (!webcam.srcObject) {
                alert("La c√°mara no est√° activa. Recarga la p√°gina y acepta los permisos.");
                return;
            }

            detectionStatus.innerText = "Analizando plato...";
            estimatedHC = 0; // Resetear HC estimados

            // Realizar predicciones
            const predictions = await mobileNetModel.classify(webcam);
            
            let detectedFoodName = "Desconocido";
            let foundFood = null;

            if (predictions.length > 0) {
                // Iterar sobre las predicciones para encontrar una coincidencia en nuestra base de datos
                for (const prediction of predictions) {
                    const label = prediction.className.toLowerCase();
                    foundFood = foodDatabase.find(food =>
                        food.keywords.some(keyword => label.includes(keyword))
                    );
                    if (foundFood) {
                        detectedFoodName = foundFood.name;
                        break; // Se encontr√≥ una coincidencia, salir del bucle
                    }
                }
            }

            detectionStatus.innerText = `Detectado: ${detectedFoodName} (Confianza: ${predictions.length > 0 ? (predictions[0].probability * 100).toFixed(1) : 0}%)`;

            if (foundFood) {
                // Estimar HC basados en el alimento detectado y el peso predefinido
                estimatedHC = (foundFood.hc_100g * foundFood.peso_estimado_g) / 100;
                hcValueSpan.innerText = estimatedHC.toFixed(0);
                estimatedHcDisplay.classList.remove('hidden');
                // Auto-rellenar el campo de gramos de HC
                document.getElementById('glucemia').focus(); // Poner el foco en la glucemia para el siguiente paso
                // Mostrar alerta de seguridad
                alert(`He detectado "${foundFood.name}". Estimo ${estimatedHC.toFixed(0)}g de HC para un peso de ${foundFood.peso_estimado_g}g. Por favor, revisa esta estimaci√≥n antes de calcular.`);
            } else {
                estimatedHcDisplay.classList.add('hidden');
                hcValueSpan.innerText = 0;
                alert("No he podido identificar un alimento de mi lista. Por favor, introduce los gramos de HC manualmente.");
            }
        });


        // --- L√ìGICA DE C√ÅLCULO DE INSULINA ---
        function calcularDosis() {
            // Captura de datos
            const dti = parseFloat(document.getElementById('dti').value);
            const objetivo = parseFloat(document.getElementById('objetivo').value);
            const glucemia = parseFloat(document.getElementById('glucemia').value);
            // Si la IA ha estimado HC, se usan esos. Si no, se puede dejar el campo manual o pedir que el usuario lo rellene.
            const gramos = estimatedHC > 0 ? estimatedHC : parseFloat(document.getElementById('gramos').value || 0);
            
            if (!dti || !glucemia || isNaN(gramos) || gramos <= 0) {
                alert("Por favor, introduce tu glucemia, aseg√∫rate que el DTI es correcto y que hay HC (detectados o manuales) para calcular.");
                return;
            }

            // --- F√ìRMULAS DEL PDF ---
            
            // 1. Convertir gramos a raciones (1 Raci√≥n = 10g)
            const raciones = gramos / 10;

            // 2. Factor de Sensibilidad (FSI) - Regla 1800
            // Cu√°nto baja 1 unidad de insulina la glucosa
            const fsi = 1800 / dti;

            // 3. Ratio Insulina/Raci√≥n - Regla 500
            // Cu√°ntas unidades se necesitan por cada raci√≥n (10g)
            // F√≥rmula: (10 / (500 / DTI))
            const uiPorRacion = 10 / (500 / dti);

            // 4. C√°lculos de Bolo
            const boloComida = raciones * uiPorRacion;
            
            let boloCorrector = 0;
            if (glucemia > objetivo) {
                boloCorrector = (glucemia - objetivo) / fsi;
            }

            const total = boloComida + boloCorrector;

            // --- MOSTRAR RESULTADOS ---
            document.getElementById('resultado').classList.remove('hidden');
            document.getElementById('total-ui').innerHTML = `${total.toFixed(1)} <span class="text-xl">UI</span>`;
            document.getElementById('txt-raciones').innerText = `${raciones.toFixed(1)} Raciones`;
            document.getElementById('ui-comida').innerText = `${boloComida.toFixed(1)} UI`;
            document.getElementById('ui-correccion').innerText = `${boloCorrector.toFixed(1)} UI`;

            // Alerta de Hipoglucemia
            const alertaHipo = document.getElementById('alerta-hipo');
            if (glucemia < 70) {
                alertaHipo.classList.remove('hidden');
            } else {
                alertaHipo.classList.add('hidden');
            }

            // L√≠mite de seguridad para evitar errores de escritura o IA
            if (total > 15) {
                alert("‚ö†Ô∏è AVISO DE SEGURIDAD: El c√°lculo supera las 15 unidades. Revisa si la estimaci√≥n de HC es correcta.");
            }
        }

        // Inicializar la aplicaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', setupCameraAndModel);
    </script>
</body>
</html>
