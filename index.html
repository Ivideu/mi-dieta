<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diabetes AI - Ivideu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 font-sans">

    <div class="max-w-md mx-auto space-y-4">
        <header class="text-center py-2">
            <h1 class="text-2xl font-bold text-blue-400">Diabetes Cam v2</h1>
            <p class="text-gray-400 text-xs">DTI configurada: 54</p>
        </header>

        <div class="relative bg-black rounded-2xl overflow-hidden border-2 border-blue-500 shadow-lg shadow-blue-500/20">
            <video id="video" autoplay playsinline class="w-full h-64 object-cover"></video>
            <div id="loading-ia" class="absolute inset-0 flex items-center justify-center bg-black/70">
                <span class="text-sm">Iniciando C치mara e IA...</span>
            </div>
            <button onclick="detectarPlato()" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-full font-bold shadow-xl">
                游닞 ANALIZAR PLATO
            </button>
        </div>

        <div id="info-comida" class="bg-gray-800 p-4 rounded-xl border border-gray-700 hidden">
            <p class="text-sm text-gray-400">Alimento detectado:</p>
            <p id="nombre-alimento" class="text-xl font-bold text-green-400 uppercase">---</p>
            <p id="hc-estimados" class="text-sm text-blue-300 font-bold mt-1">HC Estimados: 0g</p>
        </div>

        <div class="bg-gray-800 p-5 rounded-2xl space-y-4 shadow-xl">
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Glucemia Actual (mg/dL)</label>
                <input type="number" id="glucemia" placeholder="Ej: 150" class="w-full bg-gray-700 border-none p-3 rounded-lg text-xl text-white focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 uppercase text-blue-400">Hidratos de Carbono (g)</label>
                <input type="number" id="hc_input" placeholder="Gramos de HC" class="w-full bg-gray-700 border-none p-3 rounded-lg text-xl text-white focus:ring-2 focus:ring-blue-500">
                <p class="text-[10px] text-gray-500 mt-1 italic">* Si la c치mara detecta el plato, este n칰mero se pone solo.</p>
            </div>
            <button onclick="calcularTodo()" class="w-full bg-green-600 hover:bg-green-500 text-white font-black py-4 rounded-xl shadow-lg transition-transform active:scale-95">
                CALCULAR INSULINA
            </button>
        </div>

        <div id="resultado-final" class="hidden bg-white text-black p-6 rounded-3xl shadow-2xl border-4 border-green-500">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 font-bold text-xs uppercase">Dosis Recomendada</p>
                    <h2 id="total-ui" class="text-6xl font-black text-green-600">0.0<span class="text-2xl ml-1 text-green-800">UI</span></h2>
                </div>
                <div class="text-right">
                    <p id="total-raciones" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-bold text-sm">0 Raciones</p>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200 space-y-1 text-sm font-medium">
                <div class="flex justify-between text-gray-600"><span>Bolo Comida (Ratio):</span> <span id="res-comida">0 UI</span></div>
                <div class="flex justify-between text-gray-600"><span>Bolo Corrector (FSI):</span> <span id="res-correccion">0 UI</span></div>
            </div>
        </div>
    </div>

    <script>
        const DTI = 54;
        const OBJETIVO = 120;
        let model;

        // Base de datos de alimentos (P치g 6-9 del PDF)
        const alimentosDB = {
            "pan": 50, "bread": 50, "pizza": 25, "pasta": 25, "rice": 28, "arroz": 28,
            "potato": 20, "patata": 20, "apple": 12, "manzana": 12, "banana": 20, "platano": 20,
            "orange": 10, "naranja": 10, "yogurt": 5, "milk": 5
        };

        // Iniciar c치mara y IA
        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('video').srcObject = stream;
                model = await mobilenet.load();
                document.getElementById('loading-ia').style.display = 'none';
            } catch (e) {
                document.getElementById('loading-ia').innerText = "Error de c치mara. 쮻iste permisos?";
            }
        }

        async function detectarPlato() {
            if(!model) return;
            const video = document.getElementById('video');
            const predictions = await model.classify(video);
            
            // Buscar coincidencia en nuestra base de datos
            let encontrado = false;
            for(let p of predictions) {
                let pName = p.className.toLowerCase();
                for(let key in alimentosDB) {
                    if(pName.includes(key)) {
                        let gramos_estimados = 150; // Asumimos raci칩n est치ndar de 150g
                        let hc_final = (alimentosDB[key] * gramos_estimados) / 100;
                        
                        document.getElementById('nombre-alimento').innerText = key;
                        document.getElementById('hc-estimados').innerText = `HC Estimados: ${hc_final}g (en 150g)`;
                        document.getElementById('hc_input').value = hc_final;
                        document.getElementById('info-comida').classList.remove('hidden');
                        encontrado = true;
                        break;
                    }
                }
                if(encontrado) break;
            }
            if(!encontrado) alert("No reconozco el alimento. Por favor, pon los HC manualmente.");
        }

        function calcularTodo() {
            const glucemia = parseFloat(document.getElementById('glucemia').value);
            const hc = parseFloat(document.getElementById('hc_input').value);

            if(!glucemia || isNaN(hc)) {
                alert("Introduce glucemia e hidratos.");
                return;
            }

            // F칍RMULAS PDF P츼G 10-11
            const raciones = hc / 10;
            const fsi = 1800 / DTI; // 33.3 para DTI 54
            const ratio = 500 / DTI; // 9.2g por unidad
            
            const unidadesComida = hc / ratio;
            const unidadesCorreccion = glucemia > OBJETIVO ? (glucemia - OBJETIVO) / fsi : 0;
            const total = unidadesComida + unidadesCorreccion;

            // Mostrar resultados
            document.getElementById('resultado-final').classList.remove('hidden');
            document.getElementById('total-ui').innerHTML = `${total.toFixed(1)}<span class="text-2xl ml-1 text-green-800">UI</span>`;
            document.getElementById('total-raciones').innerText = `${raciones.toFixed(1)} Raciones`;
            document.getElementById('res-comida').innerText = `${unidadesComida.toFixed(1)} UI`;
            document.getElementById('res-correccion').innerText = `${unidadesCorreccion.toFixed(1)} UI`;

            if(total > 12) alert("춰CUIDADO! La dosis es muy alta. Revisa los datos.");
            window.scrollTo(0, document.body.scrollHeight);
        }

        init();
    </script>
</body>
</html>
